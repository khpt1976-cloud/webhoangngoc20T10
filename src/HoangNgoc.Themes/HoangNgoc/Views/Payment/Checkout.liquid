{% comment %}
Payment Checkout View - HoangNgoc Theme
Secure checkout process with VNPay and MoMo integration
{% endcomment %}

<div class="checkout-page" data-animate="fade-in">
    <div class="container">
        <div class="checkout-header">
            <h1 class="page-title">Thanh toán đơn hàng</h1>
            <div class="checkout-steps">
                <div class="step active">
                    <span class="step-number">1</span>
                    <span class="step-label">Thông tin</span>
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    <span class="step-label">Thanh toán</span>
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    <span class="step-label">Hoàn thành</span>
                </div>
            </div>
        </div>

        <div class="checkout-content">
            <div class="row">
                <!-- Order Summary -->
                <div class="col-md-4 order-md-2">
                    <div class="order-summary-card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-shopping-cart"></i>
                                Đơn hàng của bạn
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="order-items">
                                {% for item in Model.OrderItems %}
                                    <div class="order-item">
                                        <div class="item-image">
                                            {% if item.ThumbnailUrl %}
                                                <img src="{{ item.ThumbnailUrl | asset_url }}" alt="{{ item.Title }}">
                                            {% else %}
                                                <div class="item-placeholder">
                                                    <i class="fas fa-graduation-cap"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="item-details">
                                            <h4 class="item-title">{{ item.Title }}</h4>
                                            <p class="item-description">{{ item.Description | truncate: 60 }}</p>
                                            <div class="item-meta">
                                                <span class="item-type">{{ item.Type }}</span>
                                                {% if item.Duration %}
                                                    <span class="item-duration">{{ item.Duration }} giờ</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="item-price">
                                            {% if item.DiscountPrice %}
                                                <span class="original-price">{{ item.Price | currency: "VND" }}</span>
                                                <span class="discount-price">{{ item.DiscountPrice | currency: "VND" }}</span>
                                            {% else %}
                                                <span class="current-price">{{ item.Price | currency: "VND" }}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Discount Code -->
                            <div class="discount-section">
                                <div class="discount-form">
                                    <div class="input-group">
                                        <input type="text" id="discountCode" class="form-control" 
                                               placeholder="Mã giảm giá" value="{{ Model.DiscountCode }}">
                                        <button type="button" class="btn btn-outline" onclick="applyDiscount()">
                                            Áp dụng
                                        </button>
                                    </div>
                                </div>
                                {% if Model.DiscountAmount > 0 %}
                                    <div class="discount-applied">
                                        <i class="fas fa-check-circle"></i>
                                        <span>Mã "{{ Model.DiscountCode }}" đã được áp dụng</span>
                                        <button type="button" class="btn-remove" onclick="removeDiscount()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Order Total -->
                            <div class="order-total">
                                <div class="total-row">
                                    <span class="total-label">Tạm tính:</span>
                                    <span class="total-value">{{ Model.SubTotal | currency: "VND" }}</span>
                                </div>
                                {% if Model.DiscountAmount > 0 %}
                                    <div class="total-row discount">
                                        <span class="total-label">Giảm giá:</span>
                                        <span class="total-value">-{{ Model.DiscountAmount | currency: "VND" }}</span>
                                    </div>
                                {% endif %}
                                {% if Model.TaxAmount > 0 %}
                                    <div class="total-row">
                                        <span class="total-label">Thuế VAT ({{ Model.TaxRate }}%):</span>
                                        <span class="total-value">{{ Model.TaxAmount | currency: "VND" }}</span>
                                    </div>
                                {% endif %}
                                <div class="total-row final">
                                    <span class="total-label">Tổng cộng:</span>
                                    <span class="total-value">{{ Model.Total | currency: "VND" }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkout Form -->
                <div class="col-md-8 order-md-1">
                    <form id="checkoutForm" method="post" action="{{ '~/Payment/Process' | href }}" data-validate>
                        <input type="hidden" name="orderId" value="{{ Model.OrderId }}">
                        
                        <!-- Customer Information -->
                        <div class="checkout-section">
                            <h3 class="section-title">
                                <i class="fas fa-user"></i>
                                Thông tin khách hàng
                            </h3>
                            <div class="section-content">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="fullName">Họ và tên *</label>
                                            <input type="text" id="fullName" name="fullName" class="form-control" 
                                                   value="{{ Model.Customer.FullName }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="email">Email *</label>
                                            <input type="email" id="email" name="email" class="form-control" 
                                                   value="{{ Model.Customer.Email }}" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="phone">Số điện thoại *</label>
                                            <input type="tel" id="phone" name="phone" class="form-control" 
                                                   value="{{ Model.Customer.Phone }}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label" for="company">Công ty</label>
                                            <input type="text" id="company" name="company" class="form-control" 
                                                   value="{{ Model.Customer.Company }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Billing Information -->
                        <div class="checkout-section">
                            <h3 class="section-title">
                                <i class="fas fa-file-invoice"></i>
                                Thông tin hóa đơn
                            </h3>
                            <div class="section-content">
                                <div class="form-group">
                                    <div class="form-check">
                                        <input type="checkbox" id="needInvoice" name="needInvoice" class="form-check-input" 
                                               {% if Model.NeedInvoice %}checked{% endif %}>
                                        <label class="form-check-label" for="needInvoice">
                                            Tôi cần xuất hóa đơn VAT
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="invoiceDetails" class="invoice-details" 
                                     style="{% unless Model.NeedInvoice %}display: none;{% endunless %}">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label" for="companyName">Tên công ty *</label>
                                                <input type="text" id="companyName" name="companyName" class="form-control" 
                                                       value="{{ Model.Invoice.CompanyName }}">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group">
                                                <label class="form-label" for="taxCode">Mã số thuế *</label>
                                                <input type="text" id="taxCode" name="taxCode" class="form-control" 
                                                       value="{{ Model.Invoice.TaxCode }}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="companyAddress">Địa chỉ công ty *</label>
                                        <textarea id="companyAddress" name="companyAddress" class="form-control" 
                                                  rows="2">{{ Model.Invoice.CompanyAddress }}</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="checkout-section">
                            <h3 class="section-title">
                                <i class="fas fa-credit-card"></i>
                                Phương thức thanh toán
                            </h3>
                            <div class="section-content">
                                <div class="payment-methods">
                                    <!-- Wallet Payment -->
                                    {% if Model.WalletBalance >= Model.Total %}
                                        <div class="payment-method">
                                            <div class="form-check">
                                                <input type="radio" id="wallet" name="paymentMethod" value="wallet" 
                                                       class="form-check-input" checked>
                                                <label class="form-check-label" for="wallet">
                                                    <div class="method-info">
                                                        <div class="method-icon">
                                                            <i class="fas fa-wallet"></i>
                                                        </div>
                                                        <div class="method-details">
                                                            <h4>Ví điện tử HoangNgoc</h4>
                                                            <p>Số dư: {{ Model.WalletBalance | currency: "VND" }}</p>
                                                        </div>
                                                    </div>
                                                </label>
                                            </div>
                                        </div>
                                    {% endif %}

                                    <!-- VNPay -->
                                    <div class="payment-method">
                                        <div class="form-check">
                                            <input type="radio" id="vnpay" name="paymentMethod" value="vnpay" 
                                                   class="form-check-input" 
                                                   {% unless Model.WalletBalance >= Model.Total %}checked{% endunless %}>
                                            <label class="form-check-label" for="vnpay">
                                                <div class="method-info">
                                                    <div class="method-icon">
                                                        <img src="{{ '~/images/vnpay-logo.png' | href }}" alt="VNPay">
                                                    </div>
                                                    <div class="method-details">
                                                        <h4>VNPay</h4>
                                                        <p>Thanh toán qua thẻ ATM, Visa, MasterCard</p>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- MoMo -->
                                    <div class="payment-method">
                                        <div class="form-check">
                                            <input type="radio" id="momo" name="paymentMethod" value="momo" 
                                                   class="form-check-input">
                                            <label class="form-check-label" for="momo">
                                                <div class="method-info">
                                                    <div class="method-icon">
                                                        <img src="{{ '~/images/momo-logo.png' | href }}" alt="MoMo">
                                                    </div>
                                                    <div class="method-details">
                                                        <h4>Ví MoMo</h4>
                                                        <p>Thanh toán nhanh chóng với ví MoMo</p>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Bank Transfer -->
                                    <div class="payment-method">
                                        <div class="form-check">
                                            <input type="radio" id="bank" name="paymentMethod" value="bank" 
                                                   class="form-check-input">
                                            <label class="form-check-label" for="bank">
                                                <div class="method-info">
                                                    <div class="method-icon">
                                                        <i class="fas fa-university"></i>
                                                    </div>
                                                    <div class="method-details">
                                                        <h4>Chuyển khoản ngân hàng</h4>
                                                        <p>Chuyển khoản trực tiếp qua ngân hàng</p>
                                                    </div>
                                                </div>
                                            </label>
                                        </div>
                                        <div class="bank-details" style="display: none;">
                                            <div class="bank-info">
                                                <h5>Thông tin chuyển khoản:</h5>
                                                <p><strong>Ngân hàng:</strong> Vietcombank</p>
                                                <p><strong>Số tài khoản:</strong> 1234567890</p>
                                                <p><strong>Chủ tài khoản:</strong> CÔNG TY HOANG NGOC</p>
                                                <p><strong>Nội dung:</strong> {{ Model.OrderId }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Terms and Conditions -->
                        <div class="checkout-section">
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" id="agreeTerms" name="agreeTerms" class="form-check-input" required>
                                    <label class="form-check-label" for="agreeTerms">
                                        Tôi đồng ý với 
                                        <a href="{{ '~/Terms' | href }}" target="_blank">Điều khoản sử dụng</a> 
                                        và 
                                        <a href="{{ '~/Privacy' | href }}" target="_blank">Chính sách bảo mật</a>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div class="checkout-actions">
                            <button type="submit" class="btn btn-primary btn-lg btn-block" data-loading>
                                <i class="fas fa-lock"></i>
                                Thanh toán {{ Model.Total | currency: "VND" }}
                            </button>
                            <p class="security-note">
                                <i class="fas fa-shield-alt"></i>
                                Thông tin của bạn được bảo mật với mã hóa SSL 256-bit
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.checkout-page {
    padding: 2rem 0;
    min-height: 100vh;
    background-color: var(--bg-secondary);
}

.checkout-header {
    text-align: center;
    margin-bottom: 3rem;
}

.checkout-header .page-title {
    margin-bottom: 2rem;
}

.checkout-steps {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 2rem;
}

.step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-muted);
}

.step.active {
    color: var(--primary-color);
}

.step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: var(--bg-secondary);
    border: 2px solid var(--border-color);
    font-weight: 600;
    font-size: var(--font-size-sm);
}

.step.active .step-number {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
    color: var(--text-light);
}

.step-label {
    font-weight: 500;
    font-size: var(--font-size-sm);
}

.order-summary-card {
    background-color: var(--bg-primary);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-md);
    position: sticky;
    top: 100px;
}

.order-summary-card .card-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    background-color: var(--bg-secondary);
    border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
}

.order-summary-card .card-title {
    margin: 0;
    font-size: var(--font-size-lg);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.order-items {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
}

.order-item {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.order-item:last-child {
    margin-bottom: 0;
}

.item-image {
    flex: 0 0 60px;
}

.item-image img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: var(--border-radius);
}

.item-placeholder {
    width: 60px;
    height: 60px;
    background-color: var(--bg-secondary);
    border-radius: var(--border-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
}

.item-details {
    flex: 1;
    min-width: 0;
}

.item-title {
    font-size: var(--font-size-sm);
    font-weight: 600;
    margin-bottom: 0.25rem;
    line-height: 1.3;
}

.item-description {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
    margin-bottom: 0.5rem;
    line-height: 1.3;
}

.item-meta {
    display: flex;
    gap: 0.5rem;
    font-size: var(--font-size-xs);
}

.item-type,
.item-duration {
    padding: 0.125rem 0.5rem;
    background-color: var(--bg-secondary);
    border-radius: var(--border-radius-sm);
    color: var(--text-muted);
}

.item-price {
    flex: 0 0 auto;
    text-align: right;
}

.original-price {
    display: block;
    text-decoration: line-through;
    color: var(--text-muted);
    font-size: var(--font-size-xs);
}

.discount-price,
.current-price {
    display: block;
    font-weight: 700;
    color: var(--primary-color);
    font-size: var(--font-size-sm);
}

.discount-section {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
}

.discount-form .input-group {
    display: flex;
}

.discount-form .form-control {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.discount-form .btn {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
    border-left: none;
}

.discount-applied {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 0.75rem;
    background-color: rgba(16, 185, 129, 0.1);
    border-radius: var(--border-radius);
    color: var(--success-color);
    font-size: var(--font-size-sm);
}

.btn-remove {
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0;
    margin-left: auto;
}

.order-total {
    padding: 1.5rem;
}

.total-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.total-row:last-child {
    margin-bottom: 0;
}

.total-row.discount .total-value {
    color: var(--success-color);
}

.total-row.final {
    padding-top: 0.75rem;
    border-top: 1px solid var(--border-color);
    font-weight: 700;
    font-size: var(--font-size-lg);
}

.total-row.final .total-value {
    color: var(--primary-color);
}

.checkout-section {
    background-color: var(--bg-primary);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
    margin-bottom: 2rem;
    overflow: hidden;
}

.section-title {
    padding: 1.5rem;
    margin: 0;
    background-color: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    font-size: var(--font-size-lg);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-content {
    padding: 1.5rem;
}

.invoice-details {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-light);
}

.payment-methods {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.payment-method {
    border: 2px solid var(--border-color);
    border-radius: var(--border-radius);
    transition: var(--transition);
}

.payment-method:has(.form-check-input:checked) {
    border-color: var(--primary-color);
    background-color: rgba(37, 99, 235, 0.05);
}

.payment-method .form-check {
    margin: 0;
}

.payment-method .form-check-label {
    display: block;
    padding: 1.5rem;
    cursor: pointer;
    margin: 0;
}

.method-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.method-icon {
    flex: 0 0 48px;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--bg-secondary);
    border-radius: var(--border-radius);
}

.method-icon img {
    max-width: 32px;
    max-height: 32px;
}

.method-icon i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.method-details h4 {
    margin: 0 0 0.25rem 0;
    font-size: var(--font-size-base);
    font-weight: 600;
}

.method-details p {
    margin: 0;
    font-size: var(--font-size-sm);
    color: var(--text-muted);
}

.bank-details {
    padding: 1rem 1.5rem;
    background-color: var(--bg-secondary);
    border-top: 1px solid var(--border-light);
}

.bank-info h5 {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.bank-info p {
    margin-bottom: 0.5rem;
    font-size: var(--font-size-sm);
}

.checkout-actions {
    text-align: center;
    margin-top: 2rem;
}

.btn-block {
    width: 100%;
}

.security-note {
    margin-top: 1rem;
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.security-note i {
    color: var(--success-color);
}

@media (max-width: 768px) {
    .checkout-steps {
        gap: 1rem;
    }
    
    .step-label {
        display: none;
    }
    
    .order-summary-card {
        position: static;
        margin-bottom: 2rem;
    }
    
    .order-item {
        flex-direction: column;
        text-align: center;
    }
    
    .item-price {
        text-align: center;
    }
    
    .method-info {
        flex-direction: column;
        text-align: center;
    }
    
    .method-icon {
        margin: 0 auto;
    }
}
</style>

<script>
// Toggle invoice details
document.getElementById('needInvoice').addEventListener('change', function() {
    const invoiceDetails = document.getElementById('invoiceDetails');
    if (this.checked) {
        invoiceDetails.style.display = 'block';
        invoiceDetails.querySelectorAll('input, textarea').forEach(input => {
            input.required = true;
        });
    } else {
        invoiceDetails.style.display = 'none';
        invoiceDetails.querySelectorAll('input, textarea').forEach(input => {
            input.required = false;
        });
    }
});

// Toggle bank details
document.getElementById('bank').addEventListener('change', function() {
    const bankDetails = document.querySelector('.bank-details');
    if (this.checked) {
        bankDetails.style.display = 'block';
    }
});

document.querySelectorAll('input[name="paymentMethod"]:not(#bank)').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked) {
            document.querySelector('.bank-details').style.display = 'none';
        }
    });
});

// Apply discount code
function applyDiscount() {
    const code = document.getElementById('discountCode').value.trim();
    if (!code) return;
    
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="spinner"></span>';
    button.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        // Reset button
        button.innerHTML = originalText;
        button.disabled = false;
        
        // Show success/error message
        // This would be handled by the server response
        console.log('Applying discount code:', code);
    }, 1000);
}

// Remove discount code
function removeDiscount() {
    document.getElementById('discountCode').value = '';
    // This would trigger a form submission to remove the discount
    console.log('Removing discount code');
}
</script>